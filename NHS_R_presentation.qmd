---
title: "Using simulation to evaluate a service"
date: "2025-10-21"
author: Chris Mainey
Affiliation: "NHS Birmingham and Solihull ICB"
email: "c.mainey1@nhs.net"
date-format: "D MMMM YYYY"
format:
    revealjs:
        transition: slide
        auto-stretch: false
        theme: "./assets/styles.scss"
        mainfont: "Open Sans"
        toc: false
        slide-number: true
logo: "./assets/img/logo.png"
include-in-header:
    - text: |
        <style>
        .reveal .slide-logo {
        max-height: unset;
        height: 7vh;
        }
        </style>
fig-align: 'center'
fig-width: 7
fig-height: 5
execute:
    echo: false
cache: false             # Cache results
warning: false           # Do not include warnings in rendered output
error: false             # Do not include errors in the output
feeze: auto              # Re-compute previously generated computational output only in case their source file changes
crossref:
    fig-title: '**Figure**'
fig-labels: arabic
brand: "./assets/_brand.yml"
---

```{r}
#| label: load-libraries
#| warning: false
#| include: false
#| output: false

# Load the required library

library(ggplot2)
library(plotly)
library(tidyverse)
library(scales)
library(DT)
library(BSOLTheme)
library(extraDistr)

theme_set(
    theme_bsol() +
        theme(axis.text = element_text(size = unit(20, "pt")),
              axis.title = element_text(size = unit(20, "pt")),
              text = element_text(size = unit(20, "pt"))
        )
)

```



## Alternative title: {.center}

__"...what to do when you've got no data, no clear questions, and no clue if the service is working..."__



## What I'll cover: 

A few general thoughts, and a worked example, including:

+ Problem structuring
+ What is the estimand?
+ Building a (simulation) model


## Problem structuring {.incremental}

+ What real is the question?

+ Complex system, or more direct question?

+ What are the questions on the way to answering it?

+ What do we already know?

+ How could we answer it with a degree of confidence?

## Visual methods

:::: {.columns}

::: {.column width="50%"}

+ Driver diagram
+ Causal loop diagram
+ Logic model
+ Influence diagram
+ Directed acyclic graph (DAG)
+ Big bit of paper
:::

::: {.column width="50%"}

<br><br>
![](./assets/img/dag_plot.png){width="100%"}

:::

::::

## Example 

:::{.center}
![](./assets/img/cholesterol_cld.png)
:::


## What is the estimand?

::: {.incremental}
+ "The thing we are estimating"

+ We are often supplied with a pre-determined estimand:
    + _May have questionable link to the real question_
    
+ Can it be measured directly?

+ Are there confounders / biases to consider?

+ Do you need to make any adjustment (sets)?
:::

## Building a (simulation) model

::: {.incremental}
+ Mathematical version of a real-world process
  + _"What would/could out system/question look like?"_

+ Distributions / arrival rates / probabilities are key.
+ Use this knowledge to create synthetic data
+ ___Monte Carlo___ methods are useful:
    + Repeatedly sample from distributions
    + Average over many runs.

:::

## Ready to go?

<div class="tenor-gif-embed" data-postid="7111727192603868283" data-share-method="host" data-aspect-ratio="1.76596" data-width="100%"><a href="https://tenor.com/view/bilmuri-thumbs-up-good-gif-7111727192603868283">Bilmuri Thumbs Up GIF</a>from <a href="https://tenor.com/search/bilmuri-gifs">Bilmuri GIFs</a></div> <script type="text/javascript" async src="https://tenor.com/embed.js"></script>


## Real world application:

Community Care Collaboratives - part of NHS plans to shift care out of hospitals

+ Costs and Benefits
+ No existing linked data - new service
+ Unclear definitions of who is eligible
+ No clear counter factual

__System had already defined a benefit of 30,000 bed days saved per year__


## So, is it working? 

::: {.center}
<div class="tenor-gif-embed" data-postid="18174494" data-share-method="host" data-aspect-ratio="1.21212" data-width="75%"><a href="https://tenor.com/view/i-dont-know-gif-18174494">I Dont Know GIF</a>from <a href="https://tenor.com/search/i+dont+know-gifs">I Dont Know GIFs</a></div> <script type="text/javascript" async src="https://tenor.com/embed.js"></script>
:::


## Problem structuring


:::: {.columns}

::: {.column width="50%"}

+ What currently happens?
+ What happens in an ideal world?
+ What data sources have we got?




:::

::: {.column width="50%"}

![](./assets/img/diagram_CCC2.jpg)

:::

::::

:::{.incremental}
___Simulate previous fiscal year, to see if it is possible___
:::

## What is the estimand?

<br>

__Bed days saved!__

<br>

::: {.center}
![](./assets/img/discharge_date_diagram.png)
:::

___We needed to randomly assign new discharge dates___

## How?

:::: {.columns}

::: {.column width="50%"}

+ Might assume that we'd want a normal distribution of discharge dates
+ You'd need to define a mid-point and a standard deviation

__Red Herring!:__ This will give little to no variation.

:::

::: {.column width="50%"}

<br>

```{r normal}
dt_norm <- data.frame(x = seq(-3, 3, by = 0.2),
                      y = dnorm(seq(-3, 3, by = 0.2), mean = 0, sd = 1),
                      lab_x = factor(c("Ealiest \nDischarge Date", rep("",14),
                                       "Mid-point", rep("",14), "Actual \nDischarge Date"), ordered = TRUE)
                      )
dt_norm |> 
  ggplot(aes(x = x, y = y)) +
  geom_col() +
  geom_vline(xintercept = 0, color = "red", size = 1) +
  scale_x_continuous(
    breaks = dt_norm$x,  # Set breaks at x values
    labels = dt_norm$lab_x,  # Replace breaks with text labels
    limits = c(-3.5, 3.5),
    expand = c(0, 0)
  ) +
  scale_y_continuous("Density")+
  theme_minimal(base_size = 32) +
  theme(#axis.title.y = element_blank(),
        axis.title.x = element_blank())
  

```

:::

::::

## How (2)

<br>

::: {.center}
![](./assets/img/random_date.png){width="85%"}
:::

## How (3)
:::: {.columns}

::: {.column width="50%"}

+ Set EDD as 0
+ Count days to DD as MAX
+ Random value 0 - MAX


+ Need to have equal probability of any day
+ Monte Carlo method
+ 'discrete uniform' distribution

:::

::: {.column width="50%"}

<br>

```{r dunif}
dt_dunif <- data.frame(x = seq(7),
                      y = ddunif(seq(7), min = 0, max = 7),
                      lab_x = factor(c("Ealiest \nDischarge Date", rep("",2),
                                       "Mid-point", rep("",2), "Actual \nDischarge Date"), ordered = TRUE)
                      )
dt_dunif |> 
  ggplot(aes(x = x, y = y)) +
  geom_col(fill = "dodgerblue2", alpha = 0.8) +
  #geom_vline(xintercept = 0, color = "red") +
  scale_x_continuous(
    breaks = dt_dunif$x,  # Set breaks at x values
    labels = dt_dunif$lab_x,  # Replace breaks with text labels
    expand = c(0, 0)
  ) +
  scale_y_continuous("Density")+
  theme_minimal() +
  theme(#axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        text = element_text(size = unit(20, "pt"))
        )

```

:::
::::

## So we need to estimate:

+ Saving on all eligible patients
+ Saving on a proportion of eligible patients

```{r}
#| eval: false
#| include: true
#| echo: true
sim_fun <-
    function(.data, fraction_effect = 1) {
        new_dates <-  
            as.Date(.data$earliest_discharge_date + 
                        extraDistr::rdunif(nrow(.data),
                                # Earliest discharge date (EDD)
                                min = 0,
                                # No. days EDD actual discharge date
                               max = .data$DischargeDate_range)) 
  
  fraction_effect * as.numeric(sum(.data$DischargeDate - new_dates))
  }
```

## Findings: {.incremental}

+ ~50% of patients zero-day LOS (nothing to save)
+ If ___all___ patients made maximum saving: __~28,572 bd__
+ Simulation on all patients: __~14,287 bd__
+ Intervention rate is 2%: __286 bd__
+ With 10-fold increase to 20%: __~2,857 bd__



__Even being generous, 30,000 is unlikely__

## Implementation in Quarto

:::: {.columns}

::: {.column width="50%"}

+ Usual benefits of reproducibility and formats.
+ Layout is visually appealing.
+ Run the simulation dynamically on build.
+ In-line calculations in text.

:::

::: {.column width="50%"}

<br><br>
![](./assets/img/simulation_plot.png)

:::

::::


## Final thoughts

+ Be clear on the questions you are trying to answer
+ Take time to draw it out and think about it

+ Not having data is not the end!
+ What would it look like, according to your best assumptions?
